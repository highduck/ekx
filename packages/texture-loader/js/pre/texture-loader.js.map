{"version":3,"file":"texture-loader.js","sources":["../../web/dist/module/index.js"],"sourcesContent":["var webpData = \"data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAAAAAAfQ//73v/+BiOh/AAA=\";\nvar webpSupport = false;\nfetch(webpData)\n    .then(function (r) { return r.blob(); })\n    .then(function (b) { return createImageBitmap(b); })\n    .then(function () { return webpSupport = true; })\n    .catch();\nvar iMask = 0x000FFFF;\nvar vMask = 0xFFF0000;\nvar vIncr = 0x0010000;\nvar Loader = /** @class */ (function () {\n    function Loader() {\n        this.id = 0;\n        this.total = 0;\n        this.loaded = 0;\n        this.progress = 0;\n        this.w = 0;\n        this.h = 0;\n        this.images = [];\n        this.texture = null;\n        this.textureID = 0;\n        this.gl = null;\n        this.flags = 0;\n    }\n    return Loader;\n}());\nvar loaders = [null];\nvar nextFree = 1;\nfunction getPoolObjectAt(i) {\n    var obj = loaders[i];\n    if (obj === undefined) {\n        obj = new Loader();\n        // we add new element to the end of array\n        // next free index will be index + 1\n        obj.id = i + 1;\n        loaders[i] = obj;\n    }\n    return obj;\n}\nfunction genId() {\n    var index = nextFree;\n    var obj = getPoolObjectAt(index);\n    var id = obj.id;\n    nextFree = id & iMask;\n    id = index | (id & vMask);\n    obj.id = id;\n    return id;\n}\nexport function get(id) {\n    var obj = loaders[id & iMask];\n    return (obj && obj.id === id) ? obj : null;\n}\nexport function destroy(id) {\n    var obj = get(id);\n    if (obj) {\n        if (obj.images) {\n            for (var i = 0; i < obj.images.length; ++i) {\n                var img = obj.images[i];\n                if (img) {\n                    img.onload = null;\n                    img.src = \"\";\n                }\n            }\n            obj.images.length = 0;\n        }\n        obj.texture = null;\n        obj.total = 0;\n        obj.id = ((id + vIncr) & vMask) | nextFree;\n        nextFree = id & iMask;\n        return 0;\n    }\n    return 1;\n}\nexport function load(request) {\n    var id = genId();\n    var loader = loaders[id & iMask];\n    loader.loaded = 0;\n    loader.total = request.urls.length;\n    loader.flags = request.flags;\n    loader.gl = request.gl || (!!GL ? GL.currentContext.GLctx : null);\n    var basePath = request.basePath;\n    if (basePath && basePath.charAt(basePath.length - 1) !== \"/\") {\n        basePath += \"/\";\n    }\n    var tryWebP = (request.formatMask & 2) !== 0 && webpSupport;\n    for (var i = 0; i < loader.total; ++i) {\n        var url = request.urls[i];\n        if (url) {\n            if (tryWebP) {\n                var lastDotIndex = url.lastIndexOf(\".\");\n                if (lastDotIndex >= 0) {\n                    url = url.substring(0, lastDotIndex) + \".webp\";\n                }\n            }\n            if (basePath) {\n                url = basePath + url;\n            }\n            var img = new Image();\n            loader.images[i] = img;\n            img.onload = function () {\n                var obj = get(id);\n                if (obj) {\n                    ++obj.loaded;\n                    obj.progress = (100 * (obj.loaded / obj.total)) | 0;\n                    if (obj.loaded >= obj.total) {\n                        var image0 = obj.images[0];\n                        obj.w = image0.width;\n                        obj.h = image0.height;\n                        var gl = obj.gl;\n                        if (gl) {\n                            var pma = !!(obj.flags & 1 /* PremultiplyAlpha */);\n                            if (pma) {\n                                gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL, true);\n                            }\n                            var cubeMap = !!(obj.flags & 2 /* CubeMap */);\n                            var texture = gl.createTexture();\n                            if (cubeMap) {\n                                var faces = [\n                                    gl.TEXTURE_CUBE_MAP_POSITIVE_X,\n                                    gl.TEXTURE_CUBE_MAP_NEGATIVE_X,\n                                    gl.TEXTURE_CUBE_MAP_POSITIVE_Y,\n                                    gl.TEXTURE_CUBE_MAP_NEGATIVE_Y,\n                                    gl.TEXTURE_CUBE_MAP_POSITIVE_Z,\n                                    gl.TEXTURE_CUBE_MAP_NEGATIVE_Z\n                                ];\n                                gl.bindTexture(gl.TEXTURE_CUBE_MAP, texture);\n                                for (var faceIndex = 0; faceIndex < faces.length; ++faceIndex) {\n                                    gl.texImage2D(faces[faceIndex], 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, obj.images[faceIndex]);\n                                }\n                                gl.texParameteri(gl.TEXTURE_CUBE_MAP, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n                                gl.texParameteri(gl.TEXTURE_CUBE_MAP, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n                                gl.texParameteri(gl.TEXTURE_CUBE_MAP, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\n                                gl.texParameteri(gl.TEXTURE_CUBE_MAP, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\n                            }\n                            else {\n                                gl.bindTexture(gl.TEXTURE_2D, texture);\n                                gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image0);\n                                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n                                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n                                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\n                                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\n                                gl.bindTexture(gl.TEXTURE_2D, null);\n                            }\n                            if (pma) {\n                                gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL, false);\n                            }\n                            obj.texture = texture;\n                            // bind webgl resource to Emscripten's GL handles\n                            if (!!GL) {\n                                var textureID = GL.getNewId(GL.textures);\n                                texture.name = textureID;\n                                GL.textures[textureID] = texture;\n                                obj.textureID = textureID;\n                            }\n                        }\n                    }\n                }\n            };\n            img.src = url;\n        }\n    }\n    return id;\n}\n//# sourceMappingURL=index.js.map"],"names":["webpSupport","fetch","then","r","blob","b","createImageBitmap","catch","iMask","vMask","Loader","this","id","total","loaded","progress","w","h","images","texture","textureID","gl","flags","loaders","nextFree","genId","index","obj","i","undefined","getPoolObjectAt","get","length","img","onload","src","request","loader","urls","GL","currentContext","GLctx","basePath","charAt","tryWebP","formatMask","url","lastDotIndex","lastIndexOf","substring","Image","image0","width","height","pma","pixelStorei","UNPACK_PREMULTIPLY_ALPHA_WEBGL","cubeMap","createTexture","faces","TEXTURE_CUBE_MAP_POSITIVE_X","TEXTURE_CUBE_MAP_NEGATIVE_X","TEXTURE_CUBE_MAP_POSITIVE_Y","TEXTURE_CUBE_MAP_NEGATIVE_Y","TEXTURE_CUBE_MAP_POSITIVE_Z","TEXTURE_CUBE_MAP_NEGATIVE_Z","bindTexture","TEXTURE_CUBE_MAP","faceIndex","texImage2D","RGBA","UNSIGNED_BYTE","texParameteri","TEXTURE_WRAP_S","CLAMP_TO_EDGE","TEXTURE_WRAP_T","TEXTURE_MIN_FILTER","LINEAR","TEXTURE_MAG_FILTER","TEXTURE_2D","getNewId","textures","name"],"mappings":"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"}
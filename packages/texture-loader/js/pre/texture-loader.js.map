{
  "version": 3,
  "sources": ["../../web/src/index.ts"],
  "sourcesContent": ["export const enum Flags {\n    PremultiplyAlpha = 1,\n    CubeMap = 2\n}\n\nconst webpData = \"data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAAAAAAfQ//73v/+BiOh/AAA=\";\nlet webpSupport = false;\n\nfetch(webpData)\n    .then(r => r.blob())\n    .then(b => createImageBitmap(b))\n    .then(() => webpSupport = true)\n    .catch();\n\nconst iMask = 0x000FFFF;\nconst vMask = 0xFFF0000;\nconst vIncr = 0x0010000;\n\nclass Loader {\n    id = 0;\n    total = 0;\n    loaded = 0;\n    progress = 0;\n    w = 0;\n    h = 0;\n    images: HTMLImageElement[] = [];\n    texture: null | WebGLTexture = null;\n    textureID: number = 0;\n    gl: null | WebGLRenderingContext = null;\n    flags = 0;\n}\n\nconst loaders: Loader[] = [null as any as Loader];\nlet nextFree = 1;\n\nfunction getPoolObjectAt(i: number) {\n    let obj = loaders[i];\n    if (obj === undefined) {\n        obj = new Loader();\n        // we add new element to the end of array\n        // next free index will be index + 1\n        obj.id = i + 1;\n        loaders[i] = obj;\n    }\n    return obj;\n}\n\nfunction genId() {\n    const index = nextFree;\n    const obj = getPoolObjectAt(index);\n    let id = obj.id;\n    nextFree = id & iMask;\n    id = index | (id & vMask);\n    obj.id = id;\n    return id;\n}\n\nexport interface LoadRequest {\n    basePath?: string;\n    urls: string[];\n    version?: string;\n    flags: Flags;\n    gl?: WebGLRenderingContext;\n    formatMask: number;\n}\n\nexport function get(id: number): Loader | null {\n    const obj = loaders[id & iMask];\n    return (obj && obj.id === id) ? obj : null;\n}\n\nexport function destroy(id: number) {\n    const obj = get(id);\n    if (obj) {\n        if(obj.images) {\n            for (let i = 0; i < obj.images.length; ++i) {\n                const img = obj.images[i];\n                if (img) {\n                    img.onload = null;\n                    img.src = \"\";\n                }\n            }\n            obj.images.length = 0;\n        }\n        obj.texture = null;\n        obj.total = 0;\n\n        obj.id = ((id + vIncr) & vMask) | nextFree;\n        nextFree = id & iMask;\n        return 0;\n    }\n    return 1;\n}\n\ninterface EmscriptenTexture extends WebGLTexture {\n    name: number;\n}\n\ninterface EmscriptenGL {\n    currentContext: {\n        GLctx: WebGLRenderingContext\n    };\n\n    textures: EmscriptenTexture[];\n\n    getNewId(textures: EmscriptenTexture[]): number;\n}\n\ndeclare const GL: EmscriptenGL;\n\nexport function load(request: LoadRequest): number {\n    const id = genId();\n    const loader = loaders[id & iMask];\n    loader.loaded = 0;\n    loader.total = request.urls.length;\n    loader.flags = request.flags;\n    loader.gl = request.gl || (!!GL ? GL.currentContext.GLctx : null);\n\n    let basePath = request.basePath;\n    if (basePath && basePath.charAt(basePath.length - 1) !== \"/\") {\n        basePath += \"/\";\n    }\n\n    const tryWebP = (request.formatMask & 2) !== 0 && webpSupport;\n\n    for (let i = 0; i < loader.total; ++i) {\n        let url = request.urls[i];\n        if (url) {\n            if (tryWebP) {\n                let lastDotIndex = url.lastIndexOf(\".\");\n                if (lastDotIndex >= 0) {\n                    url = url.substring(0, lastDotIndex) + \".webp\";\n                }\n            }\n\n            if (basePath) {\n                url = basePath + url;\n            }\n            let img = new Image();\n            loader.images[i] = img;\n            img.onload = () => {\n                const obj = get(id);\n                if (obj) {\n                    ++obj.loaded;\n                    obj.progress = (100 * (obj.loaded / obj.total)) | 0;\n                    if (obj.loaded >= obj.total) {\n                        const image0 = obj.images[0];\n                        obj.w = image0.width;\n                        obj.h = image0.height;\n                        const gl = obj.gl;\n                        if (gl) {\n                            const pma = !!(obj.flags & Flags.PremultiplyAlpha);\n                            if (pma) {\n                                gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL, true);\n                            }\n                            const cubeMap = !!(obj.flags & Flags.CubeMap);\n                            const texture = gl.createTexture() as EmscriptenTexture;\n                            if (cubeMap) {\n                                const faces = [\n                                    gl.TEXTURE_CUBE_MAP_POSITIVE_X,\n                                    gl.TEXTURE_CUBE_MAP_NEGATIVE_X,\n                                    gl.TEXTURE_CUBE_MAP_POSITIVE_Y,\n                                    gl.TEXTURE_CUBE_MAP_NEGATIVE_Y,\n                                    gl.TEXTURE_CUBE_MAP_POSITIVE_Z,\n                                    gl.TEXTURE_CUBE_MAP_NEGATIVE_Z\n                                ];\n                                gl.bindTexture(gl.TEXTURE_CUBE_MAP, texture);\n                                for (let faceIndex = 0; faceIndex < faces.length; ++faceIndex) {\n                                    gl.texImage2D(faces[faceIndex], 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, obj.images[faceIndex]);\n                                }\n                                gl.texParameteri(gl.TEXTURE_CUBE_MAP, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n                                gl.texParameteri(gl.TEXTURE_CUBE_MAP, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n                                gl.texParameteri(gl.TEXTURE_CUBE_MAP, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\n                                gl.texParameteri(gl.TEXTURE_CUBE_MAP, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\n                            } else {\n                                gl.bindTexture(gl.TEXTURE_2D, texture);\n                                gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image0);\n                                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n                                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n                                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\n                                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\n                                gl.bindTexture(gl.TEXTURE_2D, null);\n                            }\n\n                            if (pma) {\n                                gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL, false);\n                            }\n\n                            obj.texture = texture;\n\n                            // bind webgl resource to Emscripten's GL handles\n                            if (!!GL) {\n                                const textureID = GL.getNewId(GL.textures);\n                                texture.name = textureID;\n                                GL.textures[textureID] = texture;\n                                obj.textureID = textureID;\n                            }\n                        }\n                    }\n                }\n            }\n            img.src = url;\n        }\n    }\n\n    return id;\n}"],
  "mappings": "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",
  "names": []
}
